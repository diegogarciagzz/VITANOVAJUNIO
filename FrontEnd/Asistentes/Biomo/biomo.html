<!-- Ubicación: /FrontEnd/Asistentes/Biomo/biomo.html -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mawi – Mis Reportes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
     #sidebar.collapsed .sidebar-label {
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }

  .sidebar-label {
    transition: opacity 0.2s;
  }

  .rotate-180 {
    transform: rotate(180deg);
  }
    body { background:#353535;color:#fff;font-family:Inter,system-ui,sans-serif; }
    .card{background:#505050;border-radius:1rem;padding:1rem;width:280px;cursor:pointer;transition:background .2s;}
    .card:hover{background:#585858}
    .card img{width:100%;height:180px;object-fit:cover;border-radius:.5rem}
  </style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- ▸ NAVBAR ------------------------------------------------------ -->
  <header class="bg-gray-800 flex items-center justify-between h-14 px-6">
    <div class="flex items-center gap-2">
      <svg class="w-5 h-5 fill-current text-white" viewBox="0 0 24 24">
        <path d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zm0 12a5 5 0 110-10 5 5 0 010 10z"/>
        <circle cx="12" cy="12" r="2.5"/>
      </svg>
      <span class="font-semibold text-lg text-white">Mawi</span>
    </div>
    <div id="profileBtn" class="flex items-center gap-2 cursor-pointer hover:opacity-80">
      <span id="userName" class="text-sm text-white">Usuario</span>
      <img
        id="avatar"
        src="/Assets/avatar-placeholder.png"
        alt="avatar"
        class="w-8 h-8 rounded-full object-cover border-2 border-gray-700"
      />
    </div>
  </header>

  <div class="flex flex-grow overflow-hidden">
    <!-- ▸ SIDEBAR ---------------------------------------------------- -->
    <aside
      id="sidebar"
      class="bg-gray-900 w-64 flex flex-col transition-all duration-200">
      <!-- Botón para contraer/expandir -->
      <button
        id="toggleSide"
        class="self-end mt-3 mr-2 p-1 rounded hover:bg-gray-700">
        <i data-feather="chevron-left" class="w-4 h-4 text-gray-300"></i>
      </button>

      <!-- Menú de navegación -->
      <nav class="flex flex-col gap-6 mt-6 px-6 text-sm">
       <a href="/dashboard.html"
           class="flex items-center gap-3 hover:text-green-400 py-2">
          <i data-feather="home" class="w-4 h-4"></i>
          <span class="sidebar-label">Inicio</span>
        </a>

        <a
          href="/FrontEnd/Asistentes/Biomo/biomo.html"
          class="flex items-center gap-3 hover:text-green-400 py-2">
          <i data-feather="activity" class="w-4 h-4"></i>
          <span class="sidebar-label">Mis Biomos</span>
        </a>

        <a
          href="/Asistentes/Convocatorias/convocatorias.html"
          class="flex items-center gap-3 hover:text-green-400 py-2">
          <i data-feather="file-text" class="w-4 h-4"></i>
          <span class="sidebar-label">Nuevas Convocatorias</span>
        </a>

        <a
          href="/Asistentes\Convocatorias\anteproyectos.html"
          class="flex items-center gap-3 hover:text-green-400 py-2">
          <i data-feather="layers" class="w-4 h-4"></i>
          <span class="sidebar-label">Explorador Convocatorias</span>
        </a>
<a
          href="/Asistentes\Convocatorias\NuevoAnteproyecto.html"
          class="flex items-center gap-3 hover:text-green-400 py-2">
          <i data-feather="folder-plus" class="w-4 h-4"></i>
          <span class="sidebar-label"> Anteproyectos </span>
        </a>

        <a
          href="/FrontEnd/Asistentes/Convocatorias/chat.html"
          class="flex items-center gap-3 hover:text-green-400 py-2">
          <i data-feather="message-circle" class="w-4 h-4"></i>
          <span class="sidebar-label">Chatbot</span>
        </a>

        <a
          href="#"
          class="flex items-center gap-3 hover:text-green-400 py-2">
          <i data-feather="play-circle" class="w-4 h-4"></i>
          <span class="sidebar-label">Videojuego</span>
        </a>
      </nav>

      <!-- Botón cerrar sesión -->
      <button
        id="logoutBtn"
        class="flex items-center gap-3 hover:text-red-400 py-2 px-6 mt-6">
        <i data-feather="log-out" class="w-4 h-4"></i>
        <span class="sidebar-label">Cerrar sesión</span>
      </button>

      <!-- Botón Soporte -->
      <button
        id="supportBtn"
        class="mt-auto m-4 flex items-center gap-2 bg-gray-800 rounded px-4 py-2 hover:ring-2 hover:ring-green-500">
        <i data-feather="phone" class="w-4 h-4 text-green-500"></i>
        <span class="text-sm sidebar-label">Soporte</span>
      </button>
    </aside>


    <!-- CONTENIDO -->
    <main class="flex-1 overflow-y-auto p-8">
      <h1 class="text-2xl font-semibold mb-6">Mis Biomos</h1>

      <!-- Filtros -->
      <div class="flex flex-wrap gap-4 mb-6">
        <div class="relative">
          <input id="searchInput" type="text" placeholder="Buscar por ID, tipo o ecosistema" class="pl-10 pr-4 py-2 rounded-lg bg-gray-700 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500"/>
          <i data-feather="search" class="w-4 h-4 absolute left-3 top-3 text-gray-400"></i>
        </div>
        <select id="filterSelect" class="bg-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 text-sm">
          <option value="">Todos los tipos</option>
          <option value="camaras_trampa">Cámaras Trampa</option>
          <option value="validacion_cobertura">Validación Cobertura</option>
          <option value="fauna_busqueda_libre">Fauna Búsqueda Libre</option>
          <option value="fauna_transecto">Fauna Transecto</option>
          <option value="fauna_punto_conteo">Fauna Punto Conteo</option>
          <option value="variables_climaticas">Variables Climáticas</option>
        </select>
        <select id="dateSelect" class="bg-gray-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500 text-sm">
          <option value="all">Todas las fechas</option>
          <option value="15">Últimos 15 días</option>
          <option value="30">Último mes</option>
          <option value="90">Últimos 3 meses</option>
        </select>
      </div>

      <!-- Lista de Biomos -->
      <div id="biomos-list" class="grid gap-6 grid-cols-1 sm:grid-cols-2 md:grid-cols-3"></div>

      <!-- Paginación -->
      <div class="flex justify-center mt-6 gap-4" id="pagination">
        <button id="prevPage" class="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600 text-white">Anterior</button>
        <span id="pageIndicator" class="self-center text-sm text-gray-300">Página 1</span>
        <button id="nextPage" class="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600 text-white">Siguiente</button>
      </div>
    </main>
  </div>

  <script>
    feather.replace();

     
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggleSide');
    const arrow = toggleBtn.querySelector('svg');

    toggleBtn.onclick = () => {
      sidebar.classList.toggle('w-64');
      sidebar.classList.toggle('w-16');
      sidebar.classList.toggle('collapsed');
      arrow.classList.toggle('rotate-180');
    };

    const user = JSON.parse(localStorage.getItem('user') || '{}');
    const token = localStorage.getItem('token');
    if (!user.id_usuario || !token) {
      document.body.innerHTML = '<h1>Mawi</h1><p>Inicia sesión</p>';
      throw new Error('No auth');
    }

    document.getElementById('userName').textContent = user.nombre;
    const foto = localStorage.getItem('foto_perfil') || '';
    document.getElementById('avatar').src = foto.startsWith('/') ? foto : '/' + foto;

    document.getElementById('logoutBtn').onclick = () => {
      sessionStorage.clear();
      localStorage.clear();
      location.href = '/index.html';
    };
    document.getElementById('profileBtn').onclick = () => location.href = '/Perfil/perfil.html';
    document.getElementById('supportBtn').onclick = () => location.href = 'mailto:soporte@mawi.com';

    let reportesCache = [];
    let filteredReportes = [];
    let currentPage = 1;
    const itemsPerPage = 6;

    async function fetchReportes() {
      const r = await fetch(`/api/reportes/usuario/${user.id_usuario}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      reportesCache = await r.json();
      filteredReportes = [...reportesCache];
      currentPage = 1;
      renderReportes(filteredReportes);
    }

    function renderReportes(arr) {
      const cont = document.getElementById('biomos-list');
      cont.innerHTML = '';

      const totalPages = Math.ceil(arr.length / itemsPerPage);
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageItems = arr.slice(start, end);

      pageItems.forEach(rep => {
        let img = null;
        try {
          const p = JSON.parse(rep.imagenes || '[]');
          img = Array.isArray(p) ? p[0] : p;
        } catch {
          img = rep.imagenes;
        }
        const src = img ? `/imagesBiomos/${img}` : '/Assets/avatar-placeholder.png';
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <img src='${src}' class='w-full h-44 object-cover rounded-lg'>
          <h3 class='text-lg font-bold mt-2'>Biomo #${rep.id_reporte}</h3>
          <p><strong>Tipo:</strong> ${rep.record_type.replaceAll('_', ' ')}</p>
          <p><strong>Ecosistema:</strong> ${rep.tipo_ecosistema}</p>
          <p><strong>Fecha:</strong> ${new Date(rep.fecha_reporte).toLocaleDateString()}</p>`;
        div.onclick = () => location.href = `reporte.html?id=${rep.id_reporte}`;
        cont.appendChild(div);
      });

      document.getElementById('pageIndicator').textContent = `Página ${currentPage} de ${Math.max(totalPages, 1)}`;
      document.getElementById('prevPage').disabled = currentPage <= 1;
      document.getElementById('nextPage').disabled = currentPage >= totalPages;
    }

    const searchInput = document.getElementById('searchInput');
    const filterSelect = document.getElementById('filterSelect');
    const dateSelect = document.getElementById('dateSelect');

    function applyFilters() {
      const query = searchInput.value.toLowerCase();
      const typeFilter = filterSelect.value;
      const dateFilter = dateSelect.value;
      const now = new Date();

      filteredReportes = reportesCache.filter(r => {
        const matchQuery = !query ||
          r.id_reporte.toString().includes(query) ||
          r.record_type.toLowerCase().includes(query) ||
          r.tipo_ecosistema.toLowerCase().includes(query);

        const matchType = !typeFilter || r.record_type === typeFilter;

        let matchDate = true;
        if (dateFilter !== 'all') {
          const days = parseInt(dateFilter);
          const reportDate = new Date(r.fecha_reporte);
          const diffDays = (now - reportDate) / (1000 * 60 * 60 * 24);
          matchDate = diffDays <= days;
        }

        return matchQuery && matchType && matchDate;
      });

      currentPage = 1;
      renderReportes(filteredReportes);
    }

    searchInput.oninput = applyFilters;
    filterSelect.onchange = applyFilters;
    dateSelect.onchange = applyFilters;

    document.getElementById('prevPage').onclick = () => {
      if (currentPage > 1) {
        currentPage--;
        renderReportes(filteredReportes);
      }
    };

    document.getElementById('nextPage').onclick = () => {
      const totalPages = Math.ceil(filteredReportes.length / itemsPerPage);
      if (currentPage < totalPages) {
        currentPage++;
        renderReportes(filteredReportes);
      }
    };

    fetchReportes();
  </script>

</body>
</html>

